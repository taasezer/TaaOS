#!/usr/bin/env python3
"""
TaaOS Cloud Sync Manager
Manage cloud storage connections (Google Drive, Dropbox, OneDrive, Nextcloud)
"""

import sys
import os
import json
from PyQt5.QtWidgets import *
from PyQt5.QtCore import Qt, QThread, pyqtSignal

COLORS = {'primary': '#D40000', 'background': '#0A0A0A', 'surface': '#1A1A1A', 'text': '#F5F5F0'}

class CloudSyncManager(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("TaaOS Cloud Sync Manager")
        self.setGeometry(100, 100, 900, 600)
        
        self.config_file = os.path.expanduser("~/.config/taaos/cloud-sync.json")
        self.accounts = self.load_accounts()
        
        self.setup_ui()
        self.apply_theme()
    
    def setup_ui(self):
        central = QWidget()
        self.setCentralWidget(central)
        layout = QVBoxLayout(central)
        
        # Header
        header = QLabel("‚òÅÔ∏è Cloud Storage Accounts")
        header.setStyleSheet(f"font-size: 24px; color: {COLORS['primary']}; font-weight: bold; padding: 20px;")
        layout.addWidget(header)
        
        # Accounts list
        self.accounts_list = QListWidget()
        self.refresh_accounts_list()
        self.accounts_list.itemClicked.connect(self.show_account_details)
        layout.addWidget(self.accounts_list)
        
        # Buttons
        btn_layout = QHBoxLayout()
        
        add_btn = QPushButton("‚ûï Add Account")
        add_btn.clicked.connect(self.add_account)
        
        sync_btn = QPushButton("üîÑ Sync All")
        sync_btn.clicked.connect(self.sync_all)
        
        settings_btn = QPushButton("‚öôÔ∏è Settings")
        settings_btn.clicked.connect(self.show_settings)
        
        btn_layout.addWidget(add_btn)
        btn_layout.addWidget(sync_btn)
        btn_layout.addWidget(settings_btn)
        btn_layout.addStretch()
        
        layout.addLayout(btn_layout)
        
        # Status
        self.status_label = QLabel("Ready")
        self.status_label.setStyleSheet(f"color: {COLORS['text']}; padding: 10px;")
        layout.addWidget(self.status_label)
    
    def load_accounts(self):
        if os.path.exists(self.config_file):
            with open(self.config_file, 'r') as f:
                return json.load(f)
        return []
    
    def save_accounts(self):
        os.makedirs(os.path.dirname(self.config_file), exist_ok=True)
        with open(self.config_file, 'w') as f:
            json.dump(self.accounts, f, indent=2)
    
    def refresh_accounts_list(self):
        self.accounts_list.clear()
        for account in self.accounts:
            item_text = f"{account['provider']} - {account['email']} ({account['sync_folder']})"
            self.accounts_list.addItem(item_text)
    
    def add_account(self):
        dialog = AddCloudAccountDialog(self)
        if dialog.exec_():
            account = dialog.get_account_data()
            self.accounts.append(account)
            self.save_accounts()
            self.refresh_accounts_list()
    
    def show_account_details(self, item):
        index = self.accounts_list.row(item)
        account = self.accounts[index]
        
        details = f"""
Provider: {account['provider']}
Email: {account['email']}
Sync Folder: {account['sync_folder']}
Status: {'‚úÖ Synced' if account.get('synced', False) else '‚è∏Ô∏è Paused'}
Last Sync: {account.get('last_sync', 'Never')}
        """
        
        QMessageBox.information(self, "Account Details", details)
    
    def sync_all(self):
        self.status_label.setText("Syncing all accounts...")
        QMessageBox.information(self, "Sync", "Cloud sync started for all accounts")
        self.status_label.setText("Sync complete")
    
    def show_settings(self):
        QMessageBox.information(self, "Settings", "Cloud sync settings")
    
    def apply_theme(self):
        self.setStyleSheet(f"""
            QMainWindow {{ background-color: {COLORS['background']}; }}
            QWidget {{ background-color: {COLORS['surface']}; color: {COLORS['text']}; }}
            QPushButton {{
                background-color: {COLORS['primary']};
                color: {COLORS['text']};
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                font-weight: bold;
            }}
            QPushButton:hover {{ background-color: #FF3333; }}
            QListWidget {{
                background-color: {COLORS['surface']};
                border: 2px solid #2B2B2B;
                border-radius: 5px;
                padding: 10px;
            }}
            QListWidget::item {{
                padding: 15px;
                border-bottom: 1px solid #2B2B2B;
            }}
            QListWidget::item:selected {{
                background-color: {COLORS['primary']};
            }}
        """)


class AddCloudAccountDialog(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Add Cloud Account")
        self.setModal(True)
        
        layout = QFormLayout(self)
        
        self.provider_combo = QComboBox()
        self.provider_combo.addItems([
            "Google Drive",
            "Dropbox",
            "OneDrive",
            "Nextcloud",
            "pCloud",
            "MEGA",
            "Box"
        ])
        
        self.email_input = QLineEdit()
        self.sync_folder_input = QLineEdit()
        self.sync_folder_input.setText(os.path.expanduser("~/Cloud"))
        
        browse_btn = QPushButton("Browse...")
        browse_btn.clicked.connect(self.browse_folder)
        
        layout.addRow("Provider:", self.provider_combo)
        layout.addRow("Email:", self.email_input)
        layout.addRow("Sync Folder:", self.sync_folder_input)
        layout.addRow("", browse_btn)
        
        buttons = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
        buttons.accepted.connect(self.accept)
        buttons.rejected.connect(self.reject)
        layout.addRow(buttons)
    
    def browse_folder(self):
        folder = QFileDialog.getExistingDirectory(self, "Select Sync Folder")
        if folder:
            self.sync_folder_input.setText(folder)
    
    def get_account_data(self):
        return {
            'provider': self.provider_combo.currentText(),
            'email': self.email_input.text(),
            'sync_folder': self.sync_folder_input.text(),
            'synced': False,
            'last_sync': 'Never'
        }


if __name__ == '__main__':
    app = QApplication(sys.argv)
    window = CloudSyncManager()
    window.show()
    sys.exit(app.exec_())
