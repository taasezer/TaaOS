#!/usr/bin/env python3
"""
TaaOS AI Model Manager
Manages Ollama models and AI capabilities
"""

import subprocess
import json
import os
from typing import List, Dict

class AIModelManager:
    """Manages AI models for TaaOS"""
    
    def __init__(self):
        self.models_dir = "/var/lib/ollama/models"
        self.config_file = "/etc/taaos/ai-models.json"
        
        # Recommended models for TaaOS
        self.recommended_models = {
            'taaos-expert': {
                'model': 'llama3:latest',
                'purpose': 'General system assistance and troubleshooting',
                'size': '4.7GB'
            },
            'code-assistant': {
                'model': 'codellama:latest',
                'purpose': 'Code generation and analysis',
                'size': '3.8GB'
            },
            'vision': {
                'model': 'llava:latest',
                'purpose': 'Image analysis and OCR',
                'size': '4.5GB'
            },
            'lightweight': {
                'model': 'phi3:latest',
                'purpose': 'Fast responses for simple queries',
                'size': '2.3GB'
            },
            'advanced': {
                'model': 'mixtral:latest',
                'purpose': 'Complex reasoning and analysis',
                'size': '26GB'
            }
        }
    
    def list_installed(self) -> List[str]:
        """List installed models"""
        try:
            result = subprocess.run(
                ['ollama', 'list'],
                capture_output=True,
                text=True
            )
            
            models = []
            for line in result.stdout.split('\n')[1:]:
                if line.strip():
                    model_name = line.split()[0]
                    models.append(model_name)
            
            return models
        except Exception as e:
            print(f"Error listing models: {e}")
            return []
    
    def install_model(self, model_name: str):
        """Install a model"""
        print(f"Installing {model_name}...")
        try:
            subprocess.run(['ollama', 'pull', model_name], check=True)
            print(f"✓ {model_name} installed successfully")
        except subprocess.CalledProcessError as e:
            print(f"✗ Failed to install {model_name}: {e}")
    
    def remove_model(self, model_name: str):
        """Remove a model"""
        print(f"Removing {model_name}...")
        try:
            subprocess.run(['ollama', 'rm', model_name], check=True)
            print(f"✓ {model_name} removed successfully")
        except subprocess.CalledProcessError as e:
            print(f"✗ Failed to remove {model_name}: {e}")
    
    def install_recommended(self, profile='standard'):
        """Install recommended models based on profile"""
        profiles = {
            'minimal': ['lightweight'],
            'standard': ['taaos-expert', 'code-assistant'],
            'full': ['taaos-expert', 'code-assistant', 'vision', 'lightweight'],
            'advanced': ['taaos-expert', 'code-assistant', 'vision', 'advanced']
        }
        
        models_to_install = profiles.get(profile, profiles['standard'])
        
        print(f"Installing {profile} profile...")
        for model_key in models_to_install:
            model_info = self.recommended_models[model_key]
            print(f"\n{model_key}: {model_info['purpose']}")
            print(f"Size: {model_info['size']}")
            
            self.install_model(model_info['model'])
    
    def show_recommendations(self):
        """Show recommended models"""
        print("\n=== TaaOS Recommended AI Models ===\n")
        
        for key, info in self.recommended_models.items():
            print(f"{key}:")
            print(f"  Model: {info['model']}")
            print(f"  Purpose: {info['purpose']}")
            print(f"  Size: {info['size']}")
            print()
    
    def optimize_models(self):
        """Optimize model performance"""
        print("Optimizing AI models...")
        
        # Set environment variables for performance
        env_vars = {
            'OLLAMA_NUM_PARALLEL': '2',
            'OLLAMA_MAX_LOADED_MODELS': '3',
            'OLLAMA_FLASH_ATTENTION': '1'
        }
        
        env_file = "/etc/environment"
        with open(env_file, 'a') as f:
            for key, value in env_vars.items():
                f.write(f"{key}={value}\n")
        
        print("✓ Optimization complete")
    
    def interactive_menu(self):
        """Interactive model management"""
        while True:
            print("\n=== TaaOS AI Model Manager ===")
            print("1. List installed models")
            print("2. Install recommended profile")
            print("3. Install specific model")
            print("4. Remove model")
            print("5. Show recommendations")
            print("6. Optimize performance")
            print("0. Exit")
            
            choice = input("\nSelect option: ").strip()
            
            if choice == '1':
                models = self.list_installed()
                print("\nInstalled models:")
                for model in models:
                    print(f"  - {model}")
            
            elif choice == '2':
                print("\nProfiles:")
                print("  minimal - Lightweight only (2.3GB)")
                print("  standard - Expert + Code (8.5GB)")
                print("  full - Standard + Vision (13GB)")
                print("  advanced - Full + Advanced reasoning (39GB)")
                
                profile = input("\nSelect profile: ").strip()
                self.install_recommended(profile)
            
            elif choice == '3':
                model = input("Enter model name (e.g., llama3:latest): ").strip()
                self.install_model(model)
            
            elif choice == '4':
                model = input("Enter model name to remove: ").strip()
                self.remove_model(model)
            
            elif choice == '5':
                self.show_recommendations()
            
            elif choice == '6':
                self.optimize_models()
            
            elif choice == '0':
                break

if __name__ == '__main__':
    manager = AIModelManager()
    manager.interactive_menu()
